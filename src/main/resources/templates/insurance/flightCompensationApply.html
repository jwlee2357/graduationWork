<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header">
    <title>졸업 작품</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        .form-control, .btn {
            height: calc(2.25rem + 2px);
        }
        .field-error {
            color: #dc3545;
            margin-top: 0.25rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
<div class="container" style="max-width: 60%">
    <div id="loadingContainer"></div>

    <div class="py-5 text-center">
        <h2>항공기 및 수하물 지연 보상 신청</h2>
    </div>
    <form th:action="@{/insurance/compensation/apply/flightDelay(userInsuranceId=${userInsuranceId})}" th:object="${delayForm}" method="post" novalidate>
        <input type="hidden" name="userInsuranceId" th:value="${userInsuranceId}" />

        <div th:if="${#fields.hasGlobalErrors()}">
            <p class="field-error" th:each="err : ${#fields.globalErrors()}" th:text="${err}"></p>
        </div>

        <div class="mb-3">
            <label for="flightNumber" class="form-label">항공기 번호</label>
            <input type="text" class="form-control" id="flightNumber" name="flightNum"
                   th:field="*{flightNum}" th:errorclass="field-error">
            <div class="field-error" th:errors="*{flightNum}"></div>
        </div>

        <div class="mb-3">
            <label for="departureDate" class="form-label">예정 출발 시각</label>
            <input type="datetime-local" class="form-control" id="departureDate" name="departureDate"
                   th:field="*{departureDate}" th:errorclass="field-error">
            <div class="field-error" th:errors="*{departureDate}"></div>
        </div>

        <div class="mb-3">
            <label for="compensationOption" class="form-label">보상 옵션</label>
            <select class="form-select" id="compensationOption" th:field="*{compensationOption}" th:errorclass="field-error">
                <option value="" selected>보상 옵션 선택</option>
                <option value="OPTION_EMAIL">상담 후 결정</option>
                <option value="OPTION_AUTO">자동</option>
            </select>
            <div class="field-error" th:errors="*{compensationOption}"></div>
        </div>

        <button class="w-100 btn btn-primary btn-lg" type="submit">신청</button>
    </form>

    <script>
        $(document).ready(function() {
            // 로딩 HTML을 동적으로 불러와 삽입하는 함수
            function includeLoadingHTML() {
                $('#loadingContainer').load('/fragments/loading.html', function(responseText, textStatus, jqXHR) {
                    if (textStatus === "success") {
                        $('.loading-container').hide(); // 처음에는 숨겨둠
                    } else {
                        console.error("Failed to load loading.html:", textStatus);
                    }
                });
            }

            // 로딩 중 상태를 설정하는 함수
            function showLoading() {
                $('.loading-container').show();
            }

            // 로딩이 끝난 상태를 설정하는 함수
            function hideLoading() {
                $('.loading-container').hide();
                $('.content').show();
            }

            // 에러 메시지를 표시하는 함수
            function displayErrors(errors) {
                // 모든 기존의 에러 메시지를 초기화
                $('.field-error').html('');

                // 각 에러를 필드별로 표시
                errors.forEach(function(error) {
                    var field = error.field;  // 서버가 반환한 필드명
                    var message = error.defaultMessage;  // 에러 메시지

                    // 필드명에 따라 에러 메시지를 해당하는 <div>에 삽입
                    if (field) {
                        // 필드명에 해당하는 input 또는 select의 형제 요소 중 field-error 클래스를 가진 요소에 메시지 추가
                        $('[name="' + field + '"]').closest('.mb-3').find('.field-error').html(message);
                    }
                });
            }

            includeLoadingHTML(); // 로딩 HTML 초기화

            // Form submit을 AJAX로 처리
            $('form').submit(function(event) {
                event.preventDefault(); // 폼의 기본 제출 동작을 중지

                showLoading(); // 폼이 제출되면 로딩 화면 표시

                $.ajax({
                    url: $(this).attr('action'), // Form의 action URL
                    method: $(this).attr('method'), // Form의 method
                    data: $(this).serialize(), // Form 데이터 직렬화
                    dataType: 'json', // 서버 응답을 JSON으로 처리
                    success: function(response) {
                        console.log('Form submitted successfully:', response);

                        // 서버로부터 받은 응답에서 redirectUrl을 확인하고 리다이렉트 수행
                        if (response.redirectUrl) {
                            window.location.href = response.redirectUrl; // 서버 리다이렉트 URL로 이동
                        } else {
                            hideLoading(); // 리다이렉트 URL이 없으면 로딩 화면 숨기기
                        }
                    },
                    error: function(jqXHR) {
                        console.error('Error submitting form:', jqXHR);

                        // 서버로부터 받은 에러 응답에서 errors를 확인하고 화면에 표시
                        if (jqXHR.responseJSON && jqXHR.responseJSON.errors) {
                            displayErrors(jqXHR.responseJSON.errors);
                        } else {
                            $('#errorContainer').html('Unknown error occurred.').show();
                        }

                        hideLoading(); // AJAX 요청이 실패해도 로딩 화면 숨기기
                    }
                });
            });
        });
    </script>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>
