<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header">
    <title>보험 신청 서류 업로드</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <style>
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .container {
            margin-top: 50px;
        }
        .form-label {
            font-weight: bold;
        }
    </style>
</head>
<body>
<div id="loadingContainer"></div>
    <div class="container" style="max-width: 60%">
        
    <div class="py-5 text-center">
        <h2>보험 신청 서류 업로드</h2>
    </div>
    <form th:action="@{/insurance/compensation/apply/upload(userInsuranceId=${userInsuranceId})}"
          th:object="${uploadForm}"
          enctype="multipart/form-data"
          method="post">
        <div class="mb-3">
            <label for="insuranceDocuments" class="form-label">파일 업로드</label>
            <input class="form-control" type="file" multiple="multiple" id="insuranceDocuments" name="insuranceDocuments">
        </div>
        <div class="mb-3">
            <label for="additionalInfo" class="form-label">추가 정보</label>
            <input type="text" class="form-control" id="additionalInfo" name="additionalInfo" value="상담 후 결정" readonly>
        </div>
        <button class="w-100 btn btn-primary btn-lg" type="submit">신청</button>
    </form>
</div>

<script>
    $(document).ready(function() {
        $('#loadingContainer').load('/fragments/loading.html', function() {
            $('.loading-container').hide();
        });

        $('form').submit(function(event) {
            event.preventDefault();
            $('.loading-container').show();

            var formData = new FormData(this); // FormData 객체 생성

            $.ajax({
                url: $(this).attr('action'),
                method: $(this).attr('method'),
                data: formData,
                processData: false, // 파일 업로드를 위해 필요
                contentType: false, // 파일 업로드를 위해 필요
                dataType: 'json', // JSON 응답 기대
                success: function(response) {
                    if (response.redirectUrl) {
                        window.location.href = response.redirectUrl; // 서버에서 받은 redirectUrl로 이동
                    } else {
                        $('.loading-container').hide(); // 리디렉션 URL이 없으면 로딩 화면 숨기기
                    }
                },
                error: function(jqXHR) {
                    if (jqXHR.responseJSON && jqXHR.responseJSON.errors) {
                        displayErrors(jqXHR.responseJSON.errors);
                    }
                    $('.loading-container').hide(); // AJAX 요청이 실패해도 로딩 화면 숨기기
                }
            });
        });

        function displayErrors(errors) {
            $('.field-error').html('');
            for (const [field, message] of Object.entries(errors)) {
                $('[name="' + field + '"]').closest('.mb-3').find('.field-error').html(message);
            }
        }
    });
</script>
</body>
</html>
